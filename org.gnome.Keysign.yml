id: org.gnome.Keysign
runtime: org.gnome.Platform
runtime-version: '3.30'
sdk: org.gnome.Sdk
command: gnome-keysign
copy-icon: true
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --share=network
  - --system-talk-name=org.freedesktop.Avahi
  - --system-talk-name=org.bluez
  - --allow=bluetooth
  - --device=all
  - --filesystem=~/.gnupg:ro
  - --filesystem=xdg-run/gnupg:ro
# We're waiting for webcam support: https://github.com/flatpak/xdg-desktop-portal/issues/38;
# we use --device=all meanwhile. We do network, because we're opening a port.
build-options:
  cflags: -O2 -g
  cxxflags: -O2 -g
  env:
    V: '1'
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/pkgconfig
  - /share/aclocal
  - /man
  - /share/man
  - /share/gtk-doc
  - /share/vala
  - "*.la"
  - "*.a"
modules:
  - name: pycairo
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - python3 setup.py build
      - python3 setup.py install --prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://github.com/pygobject/pycairo/releases/download/v1.13.4/pycairo-1.13.4.tar.gz
        sha256: 9e1eb50d4b61167cfde585261d93fde6ecda08f0f6c0136d3cf92abc5eb893ed

  - name: python3-pytz
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} pytz
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/10/76/52efda4ef98e7544321fd8d5d512e11739c1df18b0649551aeccfb1c8376/pytz-2018.4.tar.gz
        sha256: c06425302f2cf668f1bba7a0a03f3c1d34d4ebeef2c72003da308b3947c7f749

  - name: pygobject
    build-options:
      env:
        PYTHON: python3
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: http://ftp.acc.umu.se/pub/GNOME/sources/pygobject/3.28/pygobject-3.28.2.tar.xz
        sha256: ac443afd14fcb9ff5744b65d6e2b380e70510278404fb8684a9b9fb089e6f2ca

  - name: swig
    config-opts:
      - "--without-boost"
      - "--without-pcre"
    sources:
      - type: archive
        url: http://prdownloads.sourceforge.net/swig/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d

  - name: python3-dbus-python
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} dbus-python
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/3f/e7/4edb582d1ffd5ac3c84188deea32e960b5c8c0fe1da56ce70224f85ce542/dbus-python-1.2.8.tar.gz
        sha256: abf12bbb765e300bf8e2a1b2f32f85949eab06998dbda127952c31cb63957b6f

  - name: avahi
    # hrm, I don't want to install this, but we need the python module
    rm-configure: true
    config-opts:
      - "--disable-static"
      - "--disable-mono"
      - "--disable-monodoc"
      - "--disable-qt3"
      - "--disable-qt4"
      - "--disable-gtk"
      - "--disable-gtk3"
      - "--with-distro=none"
      - "--with-systemdsystemunitdir=no"
      - "--disable-libdaemon"
      - "--disable-pygtk"
      - "--disable-gdbm"
      - "--disable-manpages"
    build-options:
      env:
        PYTHON: /usr/bin/python3
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: http://avahi.org/download/avahi-0.7.tar.gz
        sha256: 57a99b5dfe7fdae794e3d1ee7a62973a368e91e414bd0dfa5d84434de5b14804

  - name: gstreamer
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gstreamer/gstreamer-1.14.4.tar.xz
        sha256: f94f6696c5f05a3b3a9183e39c5f5c0b779f75a04c0efa497e7920afa985ffc7

  - name: gst-plugins-base
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-base/gst-plugins-base-1.14.4.tar.xz
        sha256: ca6139490e48863e7706d870ff4e8ac9f417b56f3b9e4b3ce490c13b09a77461

  - name: gst-plugins-good
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-good/gst-plugins-good-1.14.4.tar.xz
        sha256: 5f8b553260cb0aac56890053d8511db1528d53cae10f0287cfce2cb2acc70979

  - name: gst-plugins-bad
    build-options:
      config-opts:
        - "--enable-zbar"
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-bad/gst-plugins-bad-1.14.4.tar.xz
        sha256: 910b4e0e2e897e8b6d06767af1779d70057c309f67292f485ff988d087aa0de5
    modules:
      - name: zbar
        build-options:
          config-opts:
            - "--disable-video"
            - "--without-xv"
            - "--without-python2"
            - "--without-gtk"
            - "--without-qt"
        sources:
          - type: git
            url: git://git.linuxtv.org/zbar.git
            commit: edcf08b49e0a5fe71c18fa9d4b8ed83ed8fc9082
          - type: shell
            commands:
                # Patch for Imagemagick 7 https://git.archlinux.org/svntogit/community.git/tree/trunk/imagemagick7.patch?h=packages/zbar&id=f80dc934f730ee4204dc51f3ef47cd2ec7406898
                - sed -i 's|wand/MagickWand.h|MagickWand/MagickWand.h|g' configure.ac
                - sed -i 's|wand/MagickWand.h|MagickWand/MagickWand.h|g' zbarimg/zbarimg.c
                # Avoid documentation
                - sed -i '48d' Makefile.am
          - type: script
            dest-filename: autogen.sh
            commands:
                - autoreconf -vfi -W none
        modules:
          - name: ImageMagick
            sources:
              - type: archive
                url: https://github.com/ImageMagick/ImageMagick/archive/7.0.8-12.tar.gz
                sha256: cd3a25183d433f3ad4f8ed6301c5ae5dfb0959c1f09b059acee447bb3881bf99

  - name: gst-python
    config-opts:
      - "--with-pygi-overrides-dir=/app/lib/python3.4/site-packages/gi/overrides/"
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-python/gst-python-1.9.1.tar.xz
        sha256: 2ab16a84efbabacfcf8f7920ab6c6725c577f08a82bf4cee45edf415a917015f

  - name: python3-babel
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} babel
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0e/d5/9b1d6a79c975d0e9a32bd337a1465518c2519b14b214682ca9892752417e/Babel-2.5.3.tar.gz
        sha256: 8ce4cb6fdd4393edd323227cba3a077bceb2a6ce5201c902c65e730046f41f14

  - name: python3-six
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} six
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/16/d8/bc6316cf98419719bd59c91742194c111b6f2e85abac88e496adefaf7afe/six-1.11.0.tar.gz
        sha256: 70e8a77beed4562e7f14fe23a786b54f6296e34344c23bc42f07b15018ff98e9

  - name: python3-qrcode
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} qrcode
    sources:
      - type: file
        url: https://pypi.python.org/packages/87/16/99038537dc58c87b136779c0e06d46887ff5104eb8c64989aac1ec8cba81/qrcode-5.3.tar.gz
        sha256: 4115ccee832620df16b659d4653568331015c718a754855caf5930805d76924e

  - name: python3-requests
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} requests
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/4d/9c/46e950a6f4d6b4be571ddcae21e7bc846fcbb88f1de3eff0f6dd0a6be55d/certifi-2018.4.16.tar.gz
        sha256: 13e698f54293db9f89122b0581843a782ad0934a4fe0172d2a980ba77fc61bb7
      - type: file
        url: https://files.pythonhosted.org/packages/ee/11/7c59620aceedcc1ef65e156cc5ce5a24ef87be4107c2b74458464e437a5d/urllib3-1.22.tar.gz
        sha256: cc44da8e1145637334317feebd728bd869a35285b93cbb4cca2577da7e62db4f
      - type: file
        url: https://files.pythonhosted.org/packages/f4/bd/0467d62790828c23c47fc1dfa1b1f052b24efdf5290f071c7a91d0d82fd3/idna-2.6.tar.gz
        sha256: 2c6a5de3089009e3da7c5dde64a141dbc8551d5b7f6cf4ed7c2568d0cc520a8f
      - type: file
        url: https://files.pythonhosted.org/packages/fc/bb/a5768c230f9ddb03acc9ef3f0d4a3cf93462473795d18e9535498c8f929d/chardet-3.0.4.tar.gz
        sha256: 84ab92ed1c4d4f16916e05906b6b75a6c0fb5db821cc65e70cbd64a3e2a5eaae
      - type: file
        url: https://files.pythonhosted.org/packages/b0/e1/eab4fc3752e3d240468a8c0b284607899d2fbfb236a56b7377a329aa8d09/requests-2.18.4.tar.gz
        sha256: 9c443e7324ba5b85070c4a818ade28bfabedf16ea10206da1132edaa6dda237e

  - name: gpgme
    sources:
      - type: archive
        url: https://www.gnupg.org/ftp/gcrypt/gpgme/gpgme-1.11.1.tar.bz2
        sha256: 2d1b111774d2e3dd26dcd7c251819ce4ef774ec5e566251eb9308fa7542fbd6f
    modules:
      - name: libassaun
        sources:
          - type: archive
            url: https://www.gnupg.org/ftp/gcrypt/libassuan/libassuan-2.5.1.tar.bz2
            sha256: 47f96c37b4f2aac289f0bc1bacfa8bd8b4b209a488d3d15e2229cb6cc9b26449
        modules:
          - name: libgpg-error
            sources:
              - type: archive
                # this is a mirror because ftp is not yet supported https://github.com/flatpak/flatpak-builder/issues/23
                url: http://mirrors.dotsrc.org/gnupg/libgpg-error/libgpg-error-1.31.tar.bz2
                sha256: 40d0a823c9329478063903192a1f82496083b277265904878f4bc09e0db7a4ef

  - gpg.yml

  - twisted[tls].yml

  - magic-wormhole.yml

  - shared-modules/udev/udev-175.json


  - name: libical
    cleanup:
    - "/lib/cmake"
    buildsystem: cmake
    config-opts:
    - "-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib"
    - "-DBUILD_SHARED_LIBS:BOOL=ON"
    sources:
    - type: archive
      url: https://github.com/libical/libical/archive/v3.0.3.tar.gz
      sha256: ef9f64540332c2aeb57f299a73c3b0de136f733ae61a281f449013159da94e7c

  - name: bluez
    config-opts:
    - "--disable-datafiles"
    - "--disable-systemd"
    - "--enable-midi"
    - "--enable-experimental"
    - "--enable-library"
    - "--prefix=/app"
    - "--sysconfdir=/app/etc"
    sources:
    - type: archive
      url: https://mirrors.edge.kernel.org/pub/linux/bluetooth/bluez-5.50.tar.xz
      sha256: 5ffcaae18bbb6155f1591be8c24898dc12f062075a40b538b745bfd477481911

  - name: python3-pybluez
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} pybluez
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c1/98/3149481d508bee174335be6725880f00d297afebe75c15e917af8f6fe169/PyBluez-0.22.zip
        sha256: 4ce006716a54d9d18e8186a3f1c8b12a8e6befecffe8fd5828a291fb694ce49d

  - name: python3-lxml
    buildsystem: simple
    build-options:
      env:
        XSLT_CONFIG: pkg-config libxslt
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} lxml
    sources:
      - type: file
        url: https://pypi.python.org/packages/e1/4c/d83979fbc66a2154850f472e69405572d89d2e6a6daee30d18e83e39ef3a/lxml-4.1.1.tar.gz
        sha256: 940caef1ec7c78e0c34b0f6b94fe42d0f2022915ffc78643d28538a5cfd0f40e

  - name: python3-future
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} future
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/00/2b/8d082ddfed935f3608cc61140df6dcbf0edea1bc3ab52fb6c29ae3e81e85/future-0.16.0.tar.gz
        sha256: e39ced1ab767b5936646cedba8bcce582398233d6a627067d4c6a454c90cfedb

  - name: gnome-keysign
    no-autogen: true
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    post-install:
      - sed -i 's|python -m|python3 -m|g' /app/share/applications/org.gnome.Keysign.desktop
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/gnome-keysign/-/archive/0.9.9/gnome-keysign-0.9.9.tar.gz
        sha256: e4b32675664a32bef9386f2f6bc187c0506f54a1c6ceff5b07377f73a85e3e39
